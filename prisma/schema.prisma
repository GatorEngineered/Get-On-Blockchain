generator client {
  provider = "prisma-client-js"
}

datasource db {
  // Using SQLite for local dev. DATABASE_URL should be: DATABASE_URL="file:./dev.db"
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Plan {
  STARTER  // Legacy - being phased out
  BASIC    // $99/mo - Points only
  PREMIUM  // $149/mo - Points + Stablecoin rewards
  GROWTH   // $249/mo - Multi-location (Phase 2)
  PRO      // $349/mo - Enterprise (Phase 2)
}

// Types for events and plans used in the app
enum EventType {
  SCAN
  CONNECT_WALLET
  CREATE_EMAIL
  REWARD_EARNED
  REWARD_REDEEMED
  PAYOUT_CLAIMED
}

enum MerchantPlan {
  STARTER  // Legacy - being phased out
  BASIC    // $99/mo - Points only
  PREMIUM  // $149/mo - Points + Stablecoin rewards
  GROWTH   // $249/mo - Multi-location (Phase 2)
  PRO      // $349/mo - Enterprise (Phase 2)
}

// Optional: you can use this later if you want ‚ÄúBronze / Silver / Gold‚Äù
enum MemberTier {
  BASE
  VIP
  SUPER
}

enum RewardType {
  EARN
  REDEEM
  ADJUST
  PAYOUT  // Stablecoin payout
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

model Business {
  id           String   @id @default(cuid())
  slug         String   @unique // e.g. "tampa-fit", "latte-lab"
  name         String
  contactEmail String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  members            BusinessMember[]
  rewardTransactions RewardTransaction[]
}

/**
 * Merchant is your internal "plan" / configuration object for the SaaS.
 * You can keep using this for pricing plans, welcome points logic, etc.
 */
model Merchant {
  id      String  @id @default(cuid())
  slug    String  @unique
  name    String
  tagline String?
  plan    Plan    @default(STARTER)

  // üîê Login fields for business portal
  loginEmail   String @unique
  passwordHash String

  // Plan configuration
  welcomePoints Int @default(10)
  earnPerVisit  Int @default(10)
  vipThreshold  Int @default(100)

  primaryColor String?
  accentColor  String?

  // üí∞ Stablecoin Payout Configuration (Premium Plan Feature)
  // Business owner funds their own custodial wallet for customer payouts
  payoutEnabled         Boolean @default(false) // Enabled after wallet setup
  payoutWalletAddress   String? // Business owner's payout wallet (NOT platform wallet)
  payoutWalletEncrypted String? // Encrypted private key (or reference to KMS)
  payoutMilestonePoints Int     @default(100) // Points needed for payout (configurable)
  payoutAmountUSD       Float   @default(5.0) // USDC amount per payout (configurable)
  payoutNetwork         String  @default("polygon") // "polygon", "ethereum", "xrpl"

  // Wallet balance tracking (updated periodically)
  lastBalanceCheck      DateTime?
  usdcBalance           Float?
  lowBalanceAlertSent   Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events Event[]
}

/**
 * Member = a real person (or account) in your system.
 * Not tied to a single business anymore.
 */
model Member {
  id        String  @id @default(cuid())
  firstName String  @default("")
  lastName  String  @default("")
  email     String  @unique
  phone     String? // optional
  address   String? // optional

  // optional global wallet if you ever want it
  walletAddress String?

  // Member tier (global across all businesses)
  tier String @default("STARTER")

  events Event[]
  loginTokens MemberLoginToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  businesses         BusinessMember[]
  rewardTransactions RewardTransaction[]
}

/**
 * Magic link tokens for passwordless member login
 */
model MemberLoginToken {
  id        String   @id @default(cuid())
  token     String   @unique
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId  String
  expiresAt DateTime
  usedAt    DateTime?
  returnTo  String?  // URL to redirect to after login

  createdAt DateTime @default(now())
}

/**
 * Link table: a Member's relationship with a specific Business.
 * This is where per-business wallet, points, and tier live.
 */
model BusinessMember {
  id         String   @id @default(cuid())
  business   Business @relation(fields: [businessId], references: [id])
  businessId String

  member   Member @relation(fields: [memberId], references: [id])
  memberId String

  // Wallet is per-business
  walletAddress String?
  walletNetwork String? // "ethereum", "xrpl", etc
  isCustodial   Boolean? // true if email-based wallet, false if external

  // Points + tier are per business
  points Int    @default(0)
  tier   String @default("BASE")

  createdAt          DateTime            @default(now())
  rewardTransactions RewardTransaction[]

  @@unique([businessId, memberId]) // same member can‚Äôt be duplicated for same business
}

/**
 * Event log for analytics / audit.
 * Still attached to Merchant and optionally Member.
 */
model Event {
  id         String   @id @default(cuid())
  merchantId String
  merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  memberId String?
  member   Member? @relation(fields: [memberId], references: [id])

  type     EventType
  source   String? // "wallet", "email", "staff", etc.
  metadata Json? // stores points, reason, etc.

  createdAt DateTime @default(now())
}

model RewardTransaction {
  id               String         @id @default(cuid())
  businessMember   BusinessMember @relation(fields: [businessMemberId], references: [id])
  businessMemberId String

  business   Business @relation(fields: [businessId], references: [id])
  businessId String

  member   Member @relation(fields: [memberId], references: [id])
  memberId String

  type   RewardType
  amount Int // Generic amount field (for backwards compatibility)

  // Points tracking
  pointsDeducted Int? // For PAYOUT type

  // Stablecoin tracking
  usdcAmount Float? // USDC amount sent (e.g., 5.0 for $5)

  currency String @default("POINTS")
  reason   String?

  // Blockchain transaction details
  txHash         String?
  walletAddress  String? // Recipient wallet
  walletNetwork  String? // "polygon", "ethereum", "xrpl"
  status         TransactionStatus @default(PENDING)
  errorMessage   String? // If status is FAILED

  createdAt DateTime @default(now())
}
