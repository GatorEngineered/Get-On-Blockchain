generator client {
  provider = "prisma-client-js"
}

datasource db {
  // Using SQLite for local dev. DATABASE_URL should be: DATABASE_URL="file:./dev.db"
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Plan {
  STARTER
  GROWTH
  PRO
}

// Types for events and plans used in the app
enum EventType {
  SCAN
  CONNECT_WALLET
  CREATE_EMAIL
  REWARD_EARNED
  REWARD_REDEEMED
}

enum MerchantPlan {
  STARTER
  GROWTH
  PRO
}

// Optional: you can use this later if you want ‚ÄúBronze / Silver / Gold‚Äù
enum MemberTier {
  BASE
  VIP
  SUPER
}

enum RewardType {
  EARN
  REDEEM
  ADJUST
}

model Business {
  id           String   @id @default(cuid())
  slug         String   @unique // e.g. "tampa-fit", "latte-lab"
  name         String
  contactEmail String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  members            BusinessMember[]
  rewardTransactions RewardTransaction[]
}

/**
 * Merchant is your internal "plan" / configuration object for the SaaS.
 * You can keep using this for pricing plans, welcome points logic, etc.
 */
model Merchant {
  id      String  @id @default(cuid())
  slug    String  @unique
  name    String
  tagline String?
  plan    Plan    @default(STARTER)

  // üîê Login fields for business portal
  loginEmail   String @unique
  passwordHash String

  // Plan configuration
  welcomePoints Int @default(10)
  earnPerVisit  Int @default(10)
  vipThreshold  Int @default(100)

  primaryColor String?
  accentColor  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events Event[]
}

/**
 * Member = a real person (or account) in your system.
 * Not tied to a single business anymore.
 */
model Member {
  id        String  @id @default(cuid())
  firstName String
  lastName  String
  email     String  @unique
  phone     String? // optional
  address   String? // optional

  // optional global wallet if you ever want it
  walletAddress String?

  events Event[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  businesses         BusinessMember[]
  rewardTransactions RewardTransaction[]
}

/**
 * Link table: a Member's relationship with a specific Business.
 * This is where per-business wallet, points, and tier live.
 */
model BusinessMember {
  id         String   @id @default(cuid())
  business   Business @relation(fields: [businessId], references: [id])
  businessId String

  member   Member @relation(fields: [memberId], references: [id])
  memberId String

  // Wallet is per-business
  walletAddress String?
  walletNetwork String? // "ethereum", "xrpl", etc
  isCustodial   Boolean? // true if email-based wallet, false if external

  // Points + tier are per business
  points Int    @default(0)
  tier   String @default("BASE")

  createdAt          DateTime            @default(now())
  rewardTransactions RewardTransaction[]

  @@unique([businessId, memberId]) // same member can‚Äôt be duplicated for same business
}

/**
 * Event log for analytics / audit.
 * Still attached to Merchant and optionally Member.
 */
model Event {
  id         String   @id @default(cuid())
  merchantId String
  merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  memberId String?
  member   Member? @relation(fields: [memberId], references: [id])

  type     EventType
  source   String? // "wallet", "email", "staff", etc.
  metadata Json? // stores points, reason, etc.

  createdAt DateTime @default(now())
}

model RewardTransaction {
  id               String         @id @default(cuid())
  businessMember   BusinessMember @relation(fields: [businessMemberId], references: [id])
  businessMemberId String

  business   Business @relation(fields: [businessId], references: [id])
  businessId String

  member   Member @relation(fields: [memberId], references: [id])
  memberId String

  type     RewardType
  amount   Int
  currency String     @default("POINTS")
  reason   String?

  txHash        String?
  walletNetwork String?

  createdAt DateTime @default(now())
}
